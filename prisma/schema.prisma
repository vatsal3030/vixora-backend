generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String                 @id @default(uuid())
  username                 String?                @unique
  email                    String?                @unique
  fullName                 String
  avatar                   String?
  coverImage               String?
  password                 String?
  refreshToken             String?
  authProvider             AuthProvider           @default(LOCAL)
  providerId               String?
  emailVerified            Boolean                @default(false)
  otpHash                  String?
  otpExpiresAt             DateTime?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  avatarPublicId           String?
  coverImagePublicId       String?
  channelDescription       String?
  channelLinks             Json?
  deletedAt                DateTime?
  isDeleted                Boolean                @default(false)
  otpAttempts              Int                    @default(0)
  otpLastSentAt            DateTime?
  pendingEmail             String?
  pendingEmailOtpHash      String?
  pendingEmailOtpExpiresAt DateTime?
  aichatSessions           AIChatSession[]
  channelCategories        ChannelCategory[]
  comments                 Comment[]
  feedScores               FeedScore[]
  feedTrainingSnapshots    FeedTrainingSnapshot[]
  likes                    Like[]
  sentNotifications        Notification[]         @relation("NotificationSender")
  notifications            Notification[]         @relation("UserNotifications")
  playlists                Playlist[]
  reportsMade              Report[]
  searchHistories          SearchHistory[]
  subscribers              Subscription[]         @relation("UserSubscribers")
  subscriptions            Subscription[]         @relation("UserSubscriptions")
  tweets                   Tweet[]
  uploadSessions           UploadSession[]
  events                   UserEvent[]
  userFeatureOverrides     UserFeatureOverride[]
  settings                 UserSettings?
  videos                   Video[]                @relation("VideoOwner")
  watchHistory             WatchHistory[]         @relation("UserWatchHistory")

  @@index([username])
  @@index([email])
  @@index([isDeleted])
}

model Tag {
  id     String     @id @default(uuid())
  name   String     @unique
  videos VideoTag[]

  @@index([name])
}

model VideoTag {
  videoId String
  tagId   String
  tag     Tag    @relation(fields: [tagId], references: [id])
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([videoId, tagId])
}

model Video {
  id                      String                   @id @default(uuid())
  videoFile               String
  thumbnail               String
  title                   String
  description             String
  duration                Int
  views                   Int                      @default(0)
  isPublished             Boolean                  @default(true)
  ownerId                 String
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  thumbnailPublicId       String
  videoPublicId           String
  aspectRatio             String?
  isShort                 Boolean                  @default(false)
  summary                 String?
  engagementScore         Float                    @default(0)
  popularityScore         Float                    @default(0)
  shareCount              Int                      @default(0)
  deletedAt               DateTime?
  isDeleted               Boolean                  @default(false)
  isHlsReady              Boolean                  @default(false)
  masterPlaylistUrl       String?
  playbackUrl             String?
  processingLockedAt      DateTime?
  processingStatus        ProcessingStatus         @default(PENDING)
  processingWorkerId      String?
  processingProgress      Float?                   @default(0)
  processingStep          String?
  processingStartedAt     DateTime?
  processingCompletedAt   DateTime?
  processingError         String?
  storageProvider         String?
  storageRegion           String?
  availableQualities      String[]                 @default(["MAX", "1080p", "720p", "480p"])
  aichatSessions          AIChatSession[]
  comments                Comment[]
  feedScores              FeedScore[]
  feedTrainingSnapshots   FeedTrainingSnapshot[]
  likes                   Like[]
  notifications           Notification[]
  playlistVideos          PlaylistVideo[]
  uploadSessions          UploadSession[]
  owner                   User                     @relation("VideoOwner", fields: [ownerId], references: [id],onDelete: Restrict)
  videoAnalyticsSnapshots VideoAnalyticsSnapshot[]
  categories              VideoCategory[]
  videoProcessingJobs     VideoProcessingJob[]
  tags                    VideoTag[]
  transcript              VideoTranscript?
  watchHistory            WatchHistory[]           @relation("VideoWatchHistory")

  @@index([ownerId])
  @@index([isPublished])
  @@index([isPublished, createdAt])
  @@index([views])
  @@index([popularityScore])
  @@index([updatedAt])
  @@index([createdAt])
  @@index([isDeleted])
  @@index([isDeleted, isPublished, createdAt])
  @@index([isDeleted, ownerId, createdAt])
  @@index([ownerId, isDeleted, deletedAt])
  @@index([ownerId, createdAt])
  @@index([isPublished, popularityScore])
}

model VideoProcessingJob {
  id             String           @id @default(uuid())
  videoId        String
  status         ProcessingStatus @default(PENDING)
  progress       Float            @default(0)
  currentStep    String?
  error          String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  idempotencyKey String?          @unique
  jobType        JobType          @default(VIDEO_PROCESSING)
  video          Video            @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
}

model BackgroundJob {
  id            String    @id @default(uuid())
  jobType       JobType
  status        JobStatus @default(PENDING)
  payload       Json?
  result        Json?
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3)
  scheduledFor  DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  error         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  correlationId String?

  @@index([jobType])
  @@index([status])
  @@index([status, scheduledFor])
}

model UploadSession {
  id             String       @id @default(uuid())
  userId         String
  videoId        String?
  status         UploadStatus @default(INITIATED)
  totalChunks    Int?
  uploadedChunks Int          @default(0)
  uploadUrl      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  totalSize      BigInt?
  uploadedSize   BigInt?
  uploadType     String? // VIDEO, IMAGE, AVATAR, POST
  cancelledAt    DateTime?
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  video          Video?       @relation(fields: [videoId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([videoId])
}

model SearchHistory {
  id        String   @id @default(uuid())
  userId    String?
  query     String
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([query])
  @@index([userId])
}

model VideoAnalyticsSnapshot {
  id               String   @id @default(uuid())
  videoId          String
  views            Int
  likes            Int
  comments         Int
  shares           Int
  watchTimeSeconds Int
  snapshotDate     DateTime
  video            Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId, snapshotDate])
}

model FeedTrainingSnapshot {
  id        String   @id @default(uuid())
  userId    String
  videoId   String
  features  Json
  label     Float?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([videoId])
}

model FeatureFlag {
  id                   String                @id @default(uuid())
  key                  String                @unique
  description          String?
  isEnabled            Boolean               @default(false)
  rolloutPercentage    Int                   @default(100)
  createdAt            DateTime              @default(now())
  userFeatureOverrides UserFeatureOverride[]
}

model UserFeatureOverride {
  id        String      @id @default(uuid())
  userId    String
  featureId String
  isEnabled Boolean
  feature   FeatureFlag @relation(fields: [featureId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureId])
}

model Category {
  id        String            @id @default(uuid())
  name      String            @unique
  slug      String            @unique
  icon      String?
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  channels  ChannelCategory[]
  videos    VideoCategory[]

  @@index([slug])
}

model ChannelCategory {
  userId     String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, categoryId])
  @@index([categoryId])
  @@index([userId])
}

model VideoCategory {
  videoId    String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([videoId, categoryId])
  @@index([categoryId, videoId])
  @@index([categoryId])
  @@index([videoId])
}

model WatchHistory {
  id            String   @id @default(uuid())
  userId        String
  videoId       String
  progress      Int
  duration      Int
  completed     Boolean  @default(false)
  watchCount    Int      @default(1)
  lastWatchedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  user          User     @relation("UserWatchHistory", fields: [userId], references: [id], onDelete: Cascade)
  video         Video    @relation("VideoWatchHistory", fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@index([lastWatchedAt])
  @@index([userId, updatedAt])
  @@index([userId, lastWatchedAt])
}

model Subscription {
  id                String            @id @default(uuid())
  subscriberId      String
  channelId         String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  notificationLevel NotificationLevel @default(PERSONALIZED)
  channel           User              @relation("UserSubscribers", fields: [channelId], references: [id], onDelete: Cascade)
  subscriber        User              @relation("UserSubscriptions", fields: [subscriberId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, channelId])
  @@index([channelId])
  @@index([subscriberId])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  videoId   String
  ownerId   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tweetId   String?
  deletedAt DateTime?
  isDeleted Boolean   @default(false)
  owner     User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tweet     Tweet?    @relation(fields: [tweetId], references: [id])
  video     Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  likes     Like[]

  @@index([videoId])
  @@index([ownerId])
  @@index([updatedAt])
  @@index([createdAt])
}

model Like {
  id        String   @id @default(uuid())
  likedById String
  videoId   String?
  commentId String?
  tweetId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  likedBy   User     @relation(fields: [likedById], references: [id], onDelete: Cascade)
  tweet     Tweet?   @relation(fields: [tweetId], references: [id], onDelete: Cascade)
  video     Video?   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([likedById, videoId])
  @@unique([likedById, commentId])
  @@unique([likedById, tweetId])
}

model Tweet {
  id        String    @id @default(uuid())
  content   String
  ownerId   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  image     String?
  imageId   String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  comments  Comment[]
  likes     Like[]
  owner     User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([updatedAt])
  @@index([createdAt])
  @@index([isDeleted, ownerId, createdAt])
}

model ShareEvent {
  id        String   @id @default(uuid())
  userId    String?
  videoId   String
  platform  String?
  createdAt DateTime @default(now())
}

model NotInterested {
  id        String   @id @default(uuid())
  userId    String
  videoId   String
  reason    String?
  createdAt DateTime @default(now())

  @@unique([userId, videoId])
  @@index([userId])
}

model BlockedChannel {
  id        String   @id @default(uuid())
  userId    String
  channelId String
  createdAt DateTime @default(now())

  @@unique([userId, channelId])
  @@index([userId])
}

model Playlist {
  id               String          @id @default(uuid())
  name             String
  description      String
  ownerId          String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  isPublic         Boolean         @default(false)
  deletedAt        DateTime?
  isDeleted        Boolean         @default(false)
  lastVideoAddedAt DateTime?
  totalDuration    Int             @default(0)
  videoCount       Int             @default(0)
  isSystem         Boolean         @default(false)
  owner            User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  videos           PlaylistVideo[]

  @@index([ownerId])
  @@index([isDeleted])
  @@index([isDeleted, ownerId, createdAt])
}

model PlaylistVideo {
  playlistId String
  videoId    String
  createdAt  DateTime @default(now())
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([playlistId, videoId])
  @@index([playlistId, createdAt])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  data      Json?
  message   String
  senderId  String?
  title     String
  type      NotificationType @default(UPLOAD)
  videoId   String?
  sender    User?            @relation("NotificationSender", fields: [senderId], references: [id])
  user      User             @relation("UserNotifications", fields: [userId], references: [id])
  video     Video?           @relation(fields: [videoId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, isRead])
}

model FeedScore {
  id              String   @id @default(uuid())
  userId          String
  videoId         String
  score           Float
  reason          String?
  createdAt       DateTime @default(now())
  engagementScore Float    @default(0)
  freshnessScore  Float    @default(0)
  interestScore   Float    @default(0)
  socialScore     Float    @default(0)
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([userId, score])
  @@index([userId, videoId])
  @@index([score, createdAt])
}

model VideoTranscript {
  id         String   @id @default(uuid())
  videoId    String   @unique
  transcript String
  segments   Json?
  language   String?
  source     String?  @default("MANUAL")
  wordCount  Int?
  generatedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
}

model AIChatSession {
  id        String          @id @default(uuid())
  userId    String?
  videoId   String?
  title     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  messages  AIChatMessage[]
  user      User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  video     Video?          @relation(fields: [videoId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([videoId])
  @@index([createdAt])
}

model AIChatMessage {
  id         String        @id @default(uuid())
  sessionId  String
  role       AIRole
  content    String
  tokensUsed Int?
  createdAt  DateTime      @default(now())
  session    AIChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

model UserEvent {
  id         String          @id @default(uuid())
  userId     String?
  sessionId  String?
  eventType  EventType
  entityType EventEntityType
  entityId   String?
  metadata   Json?
  createdAt  DateTime        @default(now())
  user       User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([eventType, createdAt])
}

model UserSettings {
  id                         String            @id @default(uuid())
  userId                     String            @unique
  profileVisibility          ProfileVisibility @default(PUBLIC)
  showSubscriptions          Boolean           @default(true)
  showLikedVideos            Boolean           @default(true)
  allowComments              Boolean           @default(true)
  allowMentions              Boolean           @default(true)
  emailNotifications         Boolean           @default(true)
  commentNotifications       Boolean           @default(true)
  subscriptionNotifications  Boolean           @default(true)
  systemAnnouncements        Boolean           @default(true)
  autoplayNext               Boolean           @default(true)
  defaultPlaybackSpeed       Float             @default(1.0)
  saveWatchHistory           Boolean           @default(true)
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @updatedAt
  hideShorts                 Boolean           @default(false)
  personalizeRecommendations Boolean           @default(true)
  showChannelName            Boolean           @default(true)
  showProgressBar            Boolean           @default(true)
  showTrending               Boolean           @default(true)
  showVideoDuration          Boolean           @default(true)
  showViewCount              Boolean           @default(true)
  user                       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Report {
  id          String           @id @default(uuid())
  reporterId  String
  targetType  ReportTargetType
  targetId    String
  reason      String
  description String?
  status      ReportStatus     @default(PENDING)
  createdAt   DateTime         @default(now())
  resolvedAt  DateTime?
  reporter    User             @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([targetType, targetId])
  @@index([status])
  @@index([createdAt])
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum VideoQuality {
  P1080
  P720
  P480
  P360
}

enum JobType {
  VIDEO_PROCESSING
  AI_SUMMARY
  AI_CHAT
  EMAIL
  NOTIFICATION
  FEED_RECOMPUTE
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  DEAD
}

enum UploadStatus {
  INITIATED
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

enum AIRole {
  USER
  ASSISTANT
  SYSTEM
}

enum EventType {
  VIDEO_VIEW
  VIDEO_COMPLETE
  VIDEO_LIKE
  VIDEO_SHARE
  VIDEO_COMMENT
  SEARCH
  SUBSCRIBE
  UNSUBSCRIBE
  NOT_INTERESTED
  REPORT
  LOGIN
  LOGOUT
}

enum EventEntityType {
  VIDEO
  USER
  COMMENT
  PLAYLIST
  CHANNEL
}

enum NotificationLevel {
  ALL
  PERSONALIZED
  NONE
}

enum NotificationType {
  COMMENT
  LIKE
  SUBSCRIPTION
  UPLOAD
  MENTION
  SYSTEM
}

enum AuthProvider {
  LOCAL
  GOOGLE
  GITHUB
  FACEBOOK
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
}

enum ReportTargetType {
  VIDEO
  COMMENT
  USER
  CHANNEL
}

enum ReportStatus {
  PENDING
  REVIEWED
  REJECTED
  ACTION_TAKEN
}
