generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String            @id @default(uuid())
  username           String?           @unique
  email              String?           @unique
  fullName           String
  avatar             String?
  coverImage         String?
  password           String?
  refreshToken       String?
  authProvider       AuthProvider      @default(LOCAL)
  providerId         String?
  emailVerified      Boolean           @default(false)
  otpHash            String?
  otpExpiresAt       DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  avatarPublicId     String?
  coverImagePublicId String?
  channelDescription String?
  channelLinks       Json?
  deletedAt          DateTime?
  isDeleted          Boolean           @default(false)
  otpAttempts        Int               @default(0)
  otpLastSentAt      DateTime?
  channelCategories  ChannelCategory[]
  comments           Comment[]
  feedScores         FeedScore[]
  likes              Like[]
  sentNotifications  Notification[]    @relation("NotificationSender")
  notifications      Notification[]    @relation("UserNotifications")
  playlists          Playlist[]
  subscribers        Subscription[]    @relation("UserSubscribers")
  subscriptions      Subscription[]    @relation("UserSubscriptions")
  tweets             Tweet[]
  settings           UserSettings?
  videos             Video[]           @relation("VideoOwner")
  watchHistory       WatchHistory[]    @relation("UserWatchHistory")

  @@index([username])
  @@index([email])
  @@index([isDeleted])
}

model Tag {
  id     String     @id @default(uuid())
  name   String     @unique
  videos VideoTag[]

  @@index([name])
}

model VideoTag {
  videoId String
  tagId   String
  tag     Tag    @relation(fields: [tagId], references: [id])
  video   Video  @relation(fields: [videoId], references: [id])

  @@id([videoId, tagId])
}

model Video {
  id                String          @id @default(uuid())
  videoFile         String
  thumbnail         String
  title             String
  description       String
  duration          Int
  views             Int             @default(0)
  isPublished       Boolean         @default(true)
  ownerId           String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  thumbnailPublicId String
  videoPublicId     String
  aspectRatio       String?
  isShort           Boolean         @default(false)
  summary           String?
  engagementScore   Float           @default(0)
  popularityScore   Float           @default(0)
  shareCount        Int             @default(0)
  deletedAt         DateTime?
  isDeleted         Boolean         @default(false)
  comments          Comment[]
  feedScores        FeedScore[]
  likes             Like[]
  notifications     Notification[]
  playlistVideos    PlaylistVideo[]
  owner             User            @relation("VideoOwner", fields: [ownerId], references: [id])
  categories        VideoCategory[]
  tags              VideoTag[]
  watchHistory      WatchHistory[]  @relation("VideoWatchHistory")

  @@index([ownerId])
  @@index([isPublished])
  @@index([isPublished, createdAt])
  @@index([views])
  @@index([popularityScore])
  @@index([updatedAt])
  @@index([createdAt])
  @@index([isDeleted])
  @@index([isDeleted, isPublished, createdAt])
  @@index([isDeleted, ownerId, createdAt])
  @@index([ownerId, isDeleted, deletedAt])
}

model Category {
  id        String            @id @default(uuid())
  name      String            @unique
  slug      String            @unique
  icon      String?
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  channels  ChannelCategory[]
  videos    VideoCategory[]

  @@index([slug])
}

model ChannelCategory {
  userId     String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, categoryId])
  @@index([categoryId])
  @@index([userId])
}

model VideoCategory {
  videoId    String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([videoId, categoryId])
  @@index([categoryId, videoId])
  @@index([categoryId])
  @@index([videoId])
}

model WatchHistory {
  id            String   @id @default(uuid())
  userId        String
  videoId       String
  progress      Int
  duration      Int
  completed     Boolean  @default(false)
  watchCount    Int      @default(1)
  lastWatchedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  user          User     @relation("UserWatchHistory", fields: [userId], references: [id], onDelete: Cascade)
  video         Video    @relation("VideoWatchHistory", fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@index([lastWatchedAt])
  @@index([userId, updatedAt])
}

model Subscription {
  id                String            @id @default(uuid())
  subscriberId      String
  channelId         String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  notificationLevel NotificationLevel @default(PERSONALIZED)
  channel           User              @relation("UserSubscribers", fields: [channelId], references: [id])
  subscriber        User              @relation("UserSubscriptions", fields: [subscriberId], references: [id])

  @@unique([subscriberId, channelId])
  @@index([channelId])
  @@index([subscriberId])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  videoId   String
  ownerId   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tweetId   String?
  deletedAt DateTime?
  isDeleted Boolean   @default(false)
  owner     User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tweet     Tweet?    @relation(fields: [tweetId], references: [id])
  video     Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  likes     Like[]

  @@index([videoId])
  @@index([ownerId])
  @@index([updatedAt])
  @@index([createdAt])
}

model Like {
  id        String   @id @default(uuid())
  likedById String
  videoId   String?
  commentId String?
  tweetId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  likedBy   User     @relation(fields: [likedById], references: [id], onDelete: Cascade)
  tweet     Tweet?   @relation(fields: [tweetId], references: [id], onDelete: Cascade)
  video     Video?   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([likedById, videoId])
  @@unique([likedById, commentId])
  @@unique([likedById, tweetId])
}

model Tweet {
  id        String    @id @default(uuid())
  content   String
  ownerId   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  image     String?
  imageId   String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  comments  Comment[]
  likes     Like[]
  owner     User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([updatedAt])
  @@index([createdAt])
  @@index([isDeleted, ownerId, createdAt])
}

model ShareEvent {
  id        String   @id @default(uuid())
  userId    String?
  videoId   String
  platform  String?
  createdAt DateTime @default(now())
}

model NotInterested {
  id        String   @id @default(uuid())
  userId    String
  videoId   String
  reason    String?
  createdAt DateTime @default(now())

  @@unique([userId, videoId])
  @@index([userId])
}

model BlockedChannel {
  id        String   @id @default(uuid())
  userId    String
  channelId String
  createdAt DateTime @default(now())

  @@unique([userId, channelId])
  @@index([userId])
}

model Playlist {
  id               String          @id @default(uuid())
  name             String
  description      String
  ownerId          String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  isPublic         Boolean         @default(false)
  deletedAt        DateTime?
  isDeleted        Boolean         @default(false)
  lastVideoAddedAt DateTime?
  totalDuration    Int             @default(0)
  videoCount       Int             @default(0)
  isSystem         Boolean         @default(false)
  owner            User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  videos           PlaylistVideo[]

  @@index([ownerId])
  @@index([isDeleted])
  @@index([isDeleted, ownerId, createdAt])
}

model PlaylistVideo {
  playlistId String
  videoId    String
  createdAt  DateTime @default(now())
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([playlistId, videoId])
  @@index([playlistId, createdAt])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  data      Json?
  message   String
  senderId  String?
  title     String
  type      NotificationType @default(UPLOAD)
  videoId   String?
  sender    User?            @relation("NotificationSender", fields: [senderId], references: [id])
  user      User             @relation("UserNotifications", fields: [userId], references: [id])
  video     Video?           @relation(fields: [videoId], references: [id])

  @@index([userId])
  @@index([userId, isRead])
}

model FeedScore {
  id              String   @id @default(uuid())
  userId          String
  videoId         String
  score           Float
  reason          String?
  createdAt       DateTime @default(now())
  engagementScore Float    @default(0)
  freshnessScore  Float    @default(0)
  interestScore   Float    @default(0)
  socialScore     Float    @default(0)
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([userId, score])
}

model UserSettings {
  id                         String            @id @default(uuid())
  userId                     String            @unique
  profileVisibility          ProfileVisibility @default(PUBLIC)
  showSubscriptions          Boolean           @default(true)
  showLikedVideos            Boolean           @default(true)
  allowComments              Boolean           @default(true)
  allowMentions              Boolean           @default(true)
  emailNotifications         Boolean           @default(true)
  commentNotifications       Boolean           @default(true)
  subscriptionNotifications  Boolean           @default(true)
  systemAnnouncements        Boolean           @default(true)
  autoplayNext               Boolean           @default(true)
  defaultPlaybackSpeed       Float             @default(1.0)
  saveWatchHistory           Boolean           @default(true)
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @updatedAt
  hideShorts                 Boolean           @default(false)
  personalizeRecommendations Boolean           @default(true)
  showChannelName            Boolean           @default(true)
  showProgressBar            Boolean           @default(true)
  showTrending               Boolean           @default(true)
  showVideoDuration          Boolean           @default(true)
  showViewCount              Boolean           @default(true)
  user                       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum NotificationLevel {
  ALL
  PERSONALIZED
  NONE
}

enum NotificationType {
  COMMENT
  LIKE
  SUBSCRIPTION
  UPLOAD
  MENTION
  SYSTEM
}

enum AuthProvider {
  LOCAL
  GOOGLE
  GITHUB
  FACEBOOK
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
}
